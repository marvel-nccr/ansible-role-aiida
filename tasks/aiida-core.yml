- name: Checkout aiida-core from GitHub
  git:
    repo: 'https://github.com/aiidateam/aiida-core.git'
    dest: "{{ aiida_source_folder }}/aiida-core"
    version: "{{ aiida_tag }}"
  register: git_checkout

- name: Read aiida-core setup.json
  slurp:
    src: "{{ aiida_source_folder }}/aiida-core/setup.json"
  register: aiida_setup_slurp

- name: Write pip requirements file
  template:
    src: pip-requirements.j2
    dest: "{{ aiida_data_folder }}/requirements.txt"
  vars:
    aiida_setup: "{{ aiida_setup_slurp.content | b64decode | from_json }}"
  register: aiida_pip_requirements

- name: Install aiida-core + plugins
  pip:
    requirements: "{{ aiida_data_folder }}/requirements.txt"
    virtualenv: "{{ aiida_venv }}"
    extra_args: "--use-feature=2020-resolver"
  register: requirements_install

- name: Install aiida-core from GitHub (editable)
  pip:
    name:
    - "{{ aiida_source_folder }}/aiida-core"
    virtualenv: "{{ aiida_venv }}"
    editable: true
    extra_args: "--no-deps"
  register: aiida_core_install
  notify: reentry scan
  # this is necessary because, for some reason, installs with
  # 'editable: true' always show as "changed"
  when: git_checkout.changed or requirements_install.changed

- meta: flush_handlers

# TODO this can be removed when aiida-core supports notebook>=6.0.1
# (which encorporates https://github.com/jupyter/notebook/pull/4772)
- name: Determine python lib path
  when: '"notebook" in aiida_extras'
  find:
    path: "{{ aiida_venv }}/lib"
    file_type: directory
    patterns: "python*"
    recurse: no
  register: python_lib

- name: Fix missing react-dom js
  when: '"notebook" in aiida_extras'
  get_url:
    url: https://unpkg.com/react-dom@16/umd/react-dom.production.min.js
    dest: "{{ item }}/site-packages/notebook/static/components/react/"
  with_items: "{{ python_lib.files | map(attribute='path') | list }}"

- name: "Activate TAB completion in virtualenv"
  lineinfile:
    path: "{{ aiida_venv }}/bin/activate"
    line: 'eval "$(verdi completioncommand)"'

- name: copy profile config
  become: true
  become_user: "{{ root_user }}"
  template:
    src: profile.yml
    dest: "{{ aiida_templates_folder |  regex_replace('\\$\\{HOME}', current_user_home) }}/profile.yml"

- name: "Check if AiiDA profile '{{ aiida_profile_name }}' has already been configured"
  shell: "{{ aiida_venv }}/bin/verdi profile show {{ aiida_profile_name }}"
  failed_when: false
  changed_when: false
  register: aiida_profile_show

- name: "Set up AiiDA profile"
  # Need to use the full path because it's in a virtualenv
  shell: |
    {{ aiida_venv }}/bin/verdi setup \
    --non-interactive \
    --config {{ aiida_templates_folder }}/profile.yml
  when: aiida_profile_show.rc != 0

- name: "Set the default AiiDA profile"
  shell: "{{ aiida_venv }}/bin/verdi profile setdefault {{ aiida_profile_name }}"
  # not ideal - better to read default profile from config
  when: aiida_profile_show.rc != 0

- name: Document aiida-core (version)
  when: release_notes is defined and release_notes
  include_role:
    name: release_notes
  vars:
    section: "AiiDA"
    option: "version"
    value: "{{ aiida_version }}"

- name: Document aiida-core (usage)
  when: release_notes is defined and release_notes
  include_role:
    name: release_notes
  vars:
    section: "AiiDA"
    option: "usage"
    value: >-
      AiiDA is installed in a Python {{ aiida_python_version }} venv: {{ aiida_venv }}.
      Type 'workon aiida' to get access to the 'verdi' commands.

- name: Document plugins
  when: release_notes is defined and release_notes
  include_role:
    name: release_notes
  vars:
    section: "AiiDA Plugins"
    option: "{{ plugin.key }}"
    value: "{{ plugin.value.version }}"
  loop: "{{ aiida_plugins|dict2items }}"
  loop_control:
    loop_var: plugin
