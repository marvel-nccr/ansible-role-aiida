---
- name: "install aiida-quantumespresso-{{ aiida_quantumespresso_version }} from PyPI"
  pip:
    name: aiida-quantumespresso
    version: "{{ aiida_quantumespresso_version }}"
    virtualenv: "{{ aiida_venv }}"
    extra_args: "--pre"  # remove after release for AiiDA 1.0 is out
  register: aiida_qe_installed
  notify: reentry scan

- meta: flush_handlers

- name: set up quantum_espresso codes for localhost
  include_tasks: code-setup.yml
  vars:
    - aiida_code:
        label: "qe-{{ quantum_espresso_version }}-{{ item.name }}"
        template: code.yml
        executable: "{{ item.name }}.x"
        folder: "{{ item.folder }}"
        plugin: "{{ item.plugin }}"
        description: "quantum_espresso v{{ quantum_espresso_version }}"
  with_items: "{{ quantum_espresso_executables }}"
  when:
    - quantum_espresso_executables is defined
    - item.plugin is defined
    - item.plugin != "quantumespresso.hp"
    - item.plugin != "wannier90"

- include_role:
    name: release_notes
  vars:
    section: "AiiDA"
    option: "aiida-quantumespresso"
    value: >-
      aiida-quantumespresso {{ aiida_quantumespresso_version }} is installed.
  when: release_notes is defined and release_notes
